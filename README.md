# Watermarking Method for Black-box Language Models

This repository contains the implementation of a watermarking method designed to embed robust watermarks into text generated by black-box language models. The method focuses on enhancing the robustness of the watermark against various text manipulations, such as deletion, substitution, polishing, and re-translation attacks.

# Overview

Our watermarking approach embeds information into the text while preserving the semantic and syntactic integrity of the original content. The method is based on two key components:

1. **Semantic Exclusion**: Identifying and excluding semantically significant words, such as proper nouns and domain-specific terms, from the watermark embedding positions.
2. **Syntactic Ordering**: Using dependency parsing to identify syntactically stable positions for embedding watermark information.

The watermarks are embedded by replacing selected words with alternatives while ensuring the text remains grammatically correct and semantically meaningful.

# Key Features

- **Robustness**: The watermarking method is resilient to several types of attacks, including word-level attacks (deletion, substitution), and document-level attacks (polishing and re-translation).
- **Text Integrity**: The watermarking process minimizes semantic distortion and maintains the syntactic structure of the original text.
- **Detection Method**: A statistical detection method is employed to detect the presence of the watermark in the watermarked text.


# Requirements and Installation

To run the code, you will need to set up a Python environment with the required dependencies. You can use `pip` to install the necessary libraries.

## Requirements

- Python 3.9.18 or higher
- `transformers==4.26.1` library
- `torch==1.7.1+cu110` (for deep learning models)
- `sentence-transformers==2.2.2` (for semantic similarity scoring)
- `spacy==3.7.2` (for dependency parsing)

You can install the required packages using `pip`:

```bash
pip install -r requirements.txt
```

The `requirements.txt` file contains all the dependencies necessary for running the watermarking method and performing experiments.

## Dependency Installation

### Paraphraser

For the vocabulary substitution step, we use the model proposed by [Qiang et al.][parals-code]. In order to run our watermarking method, you will need to first run their code. We provide two methods for integration:

#### Method 1 (Recommended):
1. Download the code from [Qiang et al.][parals-code] and set up the Python environment as specified in their instructions.
2. Install the flask library if it's not already installed.
3. Copy the `app.py` script from this repository to the main directory of Qiang et al.'s code.
4. Run the Flask service by executing:
```bash
python app.py
```

#### Method 2
1. Download and set up our code and the corresponding Python environment.
2. Install the Python environment for [Qiang et al.][parals-code].
3. Integrate all the code into a single environment. You may encounter some version conflicts with third-party Python packages, which you will need to resolve manually.

### English dependency parsing

Named entity recognition, keyword extraction, and dependency parsing to obtain dependency relation labels were performed using SpaCyâ€™s 'en-core-web-sm' model.

```bash
python -m spacy download en_core_web_sm
```

# Usage

## Embedding Watermark

To embed a watermark into a given text, use the following command:

```python
from models.utils.paraphraser import ParalsParaphraser
from models.methods.rsfph_wtgbblm import rsfph_wtgbblm


para = ParalsParaphraser(lan="en")
wm_model = rsfph_wtgbblm.RspfhWtgbblModel(paraphraser=para)
# step 1: embedding watermark
text = "Please enter a paragraph."
r1 = wm_model.watermark_text_generator(text)
print(r1)
```

## Detecting Watermark

To detect the watermark in a given text, use the following command:

```python
from models.utils.paraphraser import ParalsParaphraser
from models.methods.rsfph_wtgbblm import rsfph_wtgbblm


para = ParalsParaphraser(lan="en")
wm_model = rsfph_wtgbblm.RspfhWtgbblModel(paraphraser=para)
# step 2: detecting watermark
text = "Please enter a paragraph. (Watermarked / Not watermarked)"
r2 = wm_model.watermark_text_detector(text)
print(r2)

```

# Datasets

The code supports the following datasets, which were used in our experiments:

- `wiki_csai`
- `open_qa`
- `medicine`
- `reddit_eli5`

You can download the required datasets from [huggingface]([dataset-hc3]) or use the preprocessed versions provided in the `/ciwater_output/*` directory of this repository.

# Citation

Hao Jifei and Kang Liu and Jipeng Qiang contributed the code.
If you use this code in your research, please cite the following paper:

```bib
@inproceedings{XXX,
  title={Post-Hoc Watermarking for Robust Detection in Text Generated by Large Language Models},
  author={Jifei Hao, Jipeng Qiang, Yun Li, Yi Zhu, Yunhao Yuan, Xiaoye Ouyang},
  booktitle={},
  pages={},
  year={2025},
}
```

---
If you have any question about how to run the code. Please contact haojifei2000@gmail.com


[parals-code]: https://github.com/qiang2100/ParaLS
[dataset-hc3]: https://huggingface.co/datasets/Hello-SimpleAI/HC3